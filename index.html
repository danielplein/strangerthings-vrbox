<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <title>STRANGER THINGS VR - FINAL BOSS EDITION</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; }
        #input_video { display: none; }
        .interface {
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
            z-index: 9999; text-align: center;
        }
        .btn-ready {
            padding: 20px 50px; background: #ff0000; color: white; border: none;
            font-family: 'Courier New', monospace; font-size: 22px; font-weight: bold;
            cursor: pointer; border-radius: 12px; box-shadow: 0 0 40px #f00;
            text-transform: uppercase;
        }
    </style>
</head>
<body>

    <div class="interface">
        <button class="btn-ready" id="startBtn">Entrar no Porão (VR)</button>
    </div>
    
    <video id="input_video"></video>

    <a-scene vr-mode-ui="enabled: true" fog="type: exponential; color: #080808; density: 0.15">
        
        <a-entity id="rig" position="0 0 5">
            <a-camera id="camera" look-controls="enabled: true">
                <a-light type="spot" color="#fff" intensity="1.8" distance="15" angle="35"></a-light>
                <a-entity id="fist" 
                          geometry="primitive: sphere; radius: 0.1" 
                          material="color: #ff0000; emissive: #ff0000; emissiveIntensity: 4; opacity: 0.7; transparent: true" 
                          position="0 0 -1.5">
                </a-entity>
            </a-camera>
        </a-entity>

        <a-sky color="#020202"></a-sky>
        <a-plane rotation="-90 0 0" width="60" height="60" color="#1a120c"></a-plane>
        
        <a-box position="0 3 -6" width="18" height="7" depth="0.5" color="#2b1d0e"></a-box> 
        <a-box position="-9 3 0" rotation="0 90 0" width="12" height="7" depth="0.5" color="#2b1d0e"></a-box>
        <a-box position="9 3 0" rotation="0 90 0" width="12" height="7" depth="0.5" color="#2b1d0e"></a-box>

        <a-entity id="string-lights" position="0 4.5 -5.7"></a-entity>

        <a-box position="0 0.5 -3" width="2.2" height="0.1" depth="3.5" color="#4a3121"></a-box>
        <a-cylinder position="-1 0.25 -1.5" radius="0.06" height="0.5" color="#111"></a-cylinder>
        <a-cylinder position="1 0.25 -1.5" radius="0.06" height="0.5" color="#111"></a-cylinder>
        <a-cylinder position="-1 0.25 -4.5" radius="0.06" height="0.5" color="#111"></a-cylinder>
        <a-cylinder position="1 0.25 -4.5" radius="0.06" height="0.5" color="#111"></a-cylinder>

        <a-entity id="mike" class="target" position="-2.8 0 -4.5">
            <a-box class="body" position="0 0.5 0" width="0.7" height="1" color="#34495e"></a-box>
            <a-sphere position="0 1.4 0" radius="0.32" color="#f3dbb3"></a-sphere>
            <a-box position="0 1.6 0" width="0.75" height="0.3" depth="0.7" color="#1a1a1a"></a-box>
            <a-text value="MIKE" align="center" position="0 2.2 0" width="5"></a-text>
        </a-entity>

        <a-entity id="dustin" class="target" position="2.8 0 -4.5">
            <a-box class="body" position="0 0.5 0" width="0.7" height="1" color="#2980b9"></a-box>
            <a-sphere position="0 1.4 0" radius="0.32" color="#f3dbb3"></a-sphere>
            <a-box position="0 1.6 0.15" width="0.6" height="0.1" depth="0.5" color="#e74c3c"></a-box>
            <a-text value="DUSTIN" align="center" position="0 2.2 0" width="5"></a-text>
        </a-entity>

    </a-scene>

    <script type="module">
        const videoElement = document.getElementById('input_video');
        const fist = document.getElementById('fist');
        const targets = document.querySelectorAll('.target');
        const startBtn = document.getElementById('startBtn');
        let audioCtx;

        // Ativa o som e o VR Box
        startBtn.onclick = () => {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            document.querySelector('a-scene').enterVR();
            document.querySelector('.interface').style.display = 'none';
        };

        // Gerador de Luzes de Natal
        const lightBox = document.getElementById('string-lights');
        const colors = ['#f00', '#ff0', '#00f', '#0f0', '#f0f'];
        for(let i=0; i<16; i++) {
            const l = document.createElement('a-sphere');
            l.setAttribute('position', `${(i-7.5)*1.2} 0 0`);
            l.setAttribute('radius', '0.09');
            const c = colors[i % colors.length];
            l.setAttribute('color', c);
            l.setAttribute('light', `type: point; distance: 2.5; intensity: 1.5; color: ${c}`);
            l.setAttribute('animation', `property: light.intensity; from: 0.2; to: 2.8; dur: ${300+i*120}; loop: true; dir: alternate`);
            lightBox.appendChild(l);
        }

        // Som de Impacto (Beep de soco)
        function hitSound() {
            if(!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.setValueAtTime(100, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        }

        function onResults(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const hand = results.multiHandLandmarks[0];
                const palm = hand[9]; // Centro da mão
                
                // Mapeia a mão real para o mundo 3D
                const x = (palm.x - 0.5) * -4;
                const y = (palm.y - 0.5) * -3.5;
                const z = -1.5 + (palm.z * 4); // Profundidade do soco

                fist.setAttribute('position', {x, y, z});
                
                // Checa colisão
                const fistWorldPos = fist.object3D.getWorldPosition(new THREE.Vector3());
                targets.forEach(t => {
                    const tPos = t.object3D.position;
                    const dist = fistWorldPos.distanceTo(new THREE.Vector3(tPos.x, tPos.y + 1, tPos.z));
                    if (dist < 0.8 && t.getAttribute('data-hit') !== 'true') {
                        t.setAttribute('data-hit', 'true');
                        hitSound();
                        const body = t.querySelector('.body');
                        body.setAttribute('color', '#ff0000');
                        // Animação de impacto (vai para trás)
                        t.setAttribute('animation', 'property: position; to: 0 0 -0.8; dur: 100; dir: alternate; loop: 1');
                        setTimeout(() => {
                            body.setAttribute('color', t.id === 'mike' ? '#34495e' : '#2980b9');
                            t.setAttribute('data-hit', 'false');
                            t.removeAttribute('animation');
                        }, 300);
                    }
                });
            }
        }

        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });
        hands.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 1280, height: 720
        });
        camera.start();
    </script>
</body>
</html>
