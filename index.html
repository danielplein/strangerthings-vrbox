<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <title>Stranger Things VR - Hand Combat</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
        #loading-screen {
            position: absolute; z-index: 1000; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; color: #ff0000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; font-family: 'Courier New', Courier, monospace;
        }
        #input_video { display: none; }
        .hud { position: absolute; top: 20px; left: 20px; color: white; font-family: sans-serif; z-index: 999; text-shadow: 2px 2px #000; pointer-events: none;}
    </style>
</head>
<body>

    <div id="loading-screen">
        <h1>SISTEMA DE COMBATE</h1>
        <p>Aguardando detecção de punhos...</p>
    </div>

    <div class="hud">Dica: Aproxime a mão do boneco rapidamente para bater!</div>

    <video id="input_video"></video>

    <a-scene fog="type: exponential; color: #0a0a0a; density: 0.1">
        
        <a-entity id="rig" position="0 0 4">
            <a-camera id="camera" look-controls="enabled: true">
                <a-light type="spot" color="#fff" intensity="1.5" distance="15" angle="25"></a-light>
                <a-entity id="fist" 
                          geometry="primitive: sphere; radius: 0.1"
                          material="color: #ff0000; opacity: 0.6; transparent: true"
                          position="0 0 -1">
                </a-entity>
            </a-camera>
        </a-entity>

        <a-sky color="#050505"></a-sky>
        <a-plane id="chao" rotation="-90 0 0" width="50" height="50" color="#1a1a1a"></a-plane>
        
        <a-box position="0 2.5 -5" width="12" height="5" depth="0.2" color="#3d2b1f"></a-box>

        <a-entity id="mike" class="target" position="-1.5 0 -3">
            <a-box class="body" position="0 0.4 0" width="0.5" height="0.8" color="#2c3e50"></a-box>
            <a-sphere class="head" position="0 1.1 0" radius="0.25" color="#f3dbb3"></a-sphere>
            <a-box position="0 1.25 0" width="0.55" height="0.2" depth="0.5" color="#1a1a1a"></a-box>
            <a-text value="MIKE" align="center" position="0 1.7 0" width="4"></a-text>
        </a-entity>

        <a-entity id="dustin" class="target" position="1.5 0 -3">
            <a-box class="body" position="0 0.4 0" width="0.5" height="0.8" color="#2980b9"></a-box>
            <a-sphere class="head" position="0 1.1 0" radius="0.25" color="#f3dbb3"></a-sphere>
            <a-box position="0 1.3 0.1" width="0.4" height="0.1" depth="0.3" color="#e74c3c"></a-box>
            <a-text value="DUSTIN" align="center" position="0 1.7 0" width="4"></a-text>
        </a-entity>

    </a-scene>

    <script type="module">
        const videoElement = document.getElementById('input_video');
        const loadingScreen = document.getElementById('loading-screen');
        const fist = document.getElementById('fist');
        
        // Armazenar alvos para verificar colisão
        const targets = document.querySelectorAll('.target');

        function onResults(results) {
            if (loadingScreen.style.display !== 'none') loadingScreen.style.display = 'none';

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const hand = results.multiHandLandmarks[0];
                
                // Usamos a base da palma (ponto 0) e o dedo médio (ponto 9) para o centro da mão
                const palm = hand[9];
                
                // Mapeia a posição da mão na tela para o mundo 3D
                const x = (palm.x - 0.5) * -3;
                const y = (palm.y - 0.5) * -2;
                
                // Z é simulado pela escala da mão (se a mão está longe ou perto da câmera)
                const z = -1.5 + (palm.z * 2); 

                fist.setAttribute('position', {x: x, y: y, z: z});

                // VERIFICAR COLISÃO COM BONECOS
                checkCollision(fist.object3D.getWorldPosition(new THREE.Vector3()));
            }
        }

        function checkCollision(fistPos) {
            targets.forEach(target => {
                const targetPos = target.object3D.position;
                // Calcula distância entre o soco e o boneco (foco no peito/cabeça)
                const dist = fistPos.distanceTo(new THREE.Vector3(targetPos.x, targetPos.y + 1, targetPos.z));

                if (dist < 0.6) { // Se estiver perto o suficiente, conta como soco
                    reactToHit(target);
                }
            });
        }

        function reactToHit(el) {
            // Se o boneco já estiver reagindo, ignora para não travar
            if (el.getAttribute('data-hitting') === 'true') return;
            el.setAttribute('data-hitting', 'true');

            // Feedback Visual: Piscar vermelho e pular para trás
            const currentPos = el.getAttribute('position');
            const body = el.querySelector('.body');
            const originalColor = body.getAttribute('color');

            body.setAttribute('color', '#ff0000');
            
            el.setAttribute('animation', {
                property: 'position',
                to: `${currentPos.x} ${currentPos.y} ${currentPos.z - 0.5}`,
                dur: 100,
                dir: 'alternate',
                loop: 1
            });

            setTimeout(() => {
                body.setAttribute('color', originalColor);
                el.removeAttribute('animation');
                el.setAttribute('data-hitting', 'false');
            }, 300);
        }

        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7 });
        hands.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 640, height: 480
        });
        camera.start();
    </script>
</body>
</html>
